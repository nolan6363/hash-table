#include <stdlib.h>

#include "hashtable.h"

// FNV-1a constants for 32 bits
#define FNV_OFFSET_BASIS_32 2166136261u
#define FNV_PRIME_32 16777619u

//from http://en.wikipedia.org/wiki/Circular_shift
unsigned int _rotl(unsigned int value, int shift) {
    if ((shift &= 31) == 0)
      return value;
    return (value << shift) | (value >> (32 - shift));
}

HashTable * createHashTable(size_t keySize, size_t valueSize) {
    HashTable * hashTable = (HashTable *) malloc(sizeof(HashTable));
    hashTable->table = (KV *) calloc(STARTING_HT_SIZE, sizeof(KV));
    hashTable->tableSize = STARTING_HT_SIZE;
    hashTable->keySize = keySize;
    hashTable->valueSize = valueSize;

    return hashTable;
}

void printHashTable(HashTable * hashTable) {
    for (size_t i = 0; i < hashTable->tableSize; i++) {
        printf("[%ld] ==> ", i);
        if (hashTable->table[i].key == NULL) {
            printf("---");
        }
        else {
            printf("0x");
            for (int hex_pos = hashTable->keySize - 1; hex_pos >= 0; hex_pos--) {
                printf("%x", ((char *) hashTable->table[i].key)[hex_pos]);
            }
            printf(" : ");
            for (int hex_pos = 0; hex_pos < hashTable->valueSize; hex_pos++) {
                printf("%x", ((char *) hashTable->table[i].value)[hex_pos]);
            }
        }
        printf("\n");
    }
}

//from https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function
unsigned int hash(void * key, size_t len) {
    unsigned int hash = FNV_OFFSET_BASIS_32;
    
    for (size_t i = 0; i < len; i++) {
        hash ^= ((char *) key)[i];
        hash *= FNV_PRIME_32;
    }
    
    return hash;    
}

int HTInsert(HashTable * hashTable, void * key, void * value) {
    unsigned int pos = hash(key, hashTable->keySize) % hashTable->tableSize;
    if (hashTable->table[pos].key != NULL) {
        return 1;
    } 
    else {
        printf("adding to pos : %u\n", pos);
        printf("size of key : %lu\n", hashTable->keySize);
        printf("size of value : %lu\n", hashTable->valueSize);
        hashTable->table[pos].key = (void *) malloc(hashTable->keySize);
        hashTable->table[pos].value = (void *) malloc(hashTable->valueSize);
        memcpy(hashTable->table[pos].key, key, hashTable->keySize);
        memcpy(hashTable->table[pos].value, value, hashTable->valueSize);

        return 0;
    }
}


